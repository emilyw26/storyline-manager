<!doctype html>
<html lang="us">
<head>
    <meta charset="utf-8">
    <title>RIOT Xml Config App</title>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/dark-hive/jquery-ui.css"
          id="theme">
    <link href="css/slider.css" rel="stylesheet">
    <link href="css/accordion.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
</head>
<body>

<script>window.$ = window.jQuery = require('jquery');</script>
<script>var FileSaver = require('file-saver');</script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsviews/0.9.90/jsviews.min.js"></script>


<script src="js/accordion_multi_open.js"></script>
<script src="js/sliderValues.js"></script>
<script src="js/range.js"></script>

<div id="configurationContainer"></div>
<script id="configurationTemplate" type="text/x-jsrender">
    <div id="exportConfiguration">
        <div id="controlgroup">
          {^{for levels}}
            {{include tmpl="#levelTemplate" /}}
          {{/for}}
          <div class="buttons">
              <button class="ui-button ui-widget ui-corner-all" data-link="{on ~addLevel}">Add Level</button>
              <button class="ui-button ui-widget ui-corner-all" data-link="{on ~exportConfiguration}">Export Configuration</button>
          </div>
        </div>
    </div>
</script>

<script id="levelTemplate" type="text/x-jsrender">
    <div id="levelsAccordion{{:level}}">
        <h3>Level {{:level}}</h3>
        <div>
            <button class="removeButton" data-link="{on ~removeLevel #getIndex()}">Remove</button>
            <div class="timer-range">
                <label for="tslvl{{:level}}">Timeline
                    <span id="tslvl{{:level}}From">{^{:start}}</span> - <span id="tslvl{{:level}}To">{^{:end}}</span>
                </label>
                <div id="tslvl{{:level}}"></div>
            </div>
            {^{props branch}}
                {{include tmpl="#branchTemplate" /}}
            {{/props}}
        </div>
    </div>
</script>

<script id="branchTemplate" type="text/x-jsrender">
  <div id="branch_{{>key}}_{{:#parent.parent.parent.data.level}}">
    <h3>Branch - {{>key}}</h3>
    <div>
        <div class="timer-range">
            <label for="{{:#parent.parent.parent.data.level}}ts{{:#getIndex() + 1}}">Timeline
                <span id="ts{{:#parent.parent.parent.data.level}}{{:#getIndex + 1}}From">{^{>prop.start}}</span>
                - <span id="ts{{:#parent.parent.parent.data.level}}{{:#getIndex + 1}}To">{^{>prop.end}}</span>
            </label>
            <div id="{{:#parent.parent.parent.data.level}}ts{{:#getIndex() + 1}}"></div>
        </div>
        <div class="outcome">
            <label for="o{{:#parent.parent.parent.data.level}}{{:#getIndex() + 1}}">Outcome</label>
            <select id="o{{:#parent.parent.parent.data.level}}{{:#getIndex() + 1}}" data-link="prop.outcome">
                {^{range start=(#parent.parent.parent.data.level+1) end=~root.levels.length}}
                    <option value={{:#data}}>Level{{:#data}}</option>
                {{/range}}
                <option value="0">End</option>
            </select>
        </div>
    </div>
  </div>
</script>


<script>
  function convertStringToMilliSeconds(timeString) {
    const parts = timeString.split(':');
    return (Number(parts[0])*60+Number(parts[1].substring(0, parts[1].indexOf('.'))))*1000 + Number(parts[1].indexOf('.')+1);
  }

  const accordionConfig = {
    collapsible: true,
    autoHeight: false,
    heightStyle: 'content',
    expandable: true,
    active: false
  };

  var config;
  var levelCounter;

  var newLevel = {
    "level": 0,
    "start": "00:00.000",
    "end": "00:00.000",
    "branch" : {
      "anger": {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0
      },
      "fear": {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0
      },
      "calm": {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0
      }
    }
  };

  var helpers = {
    addLevel: function() {
      if (levelCounter === 12) return false;
      const levelValue = Object.assign({}, newLevel);
      levelValue.level = ++levelCounter;
      $.observable(config.levels).insert(levelValue);
      initLevel(levelValue);
    },
    removeLevel: function(index) {
      if (config.levels === 0) return false;
      $.observable(config.levels).remove(index);
      --levelCounter;
      return false;
    },
    exportConfiguration: function() {
      var blob = new Blob([JSON.stringify(config, null, 2)], {type: "text/plain;charset=utf-8"});
      FileSaver.saveAs(blob, "config.json");
    }
  };

  var initLevel = function (level) {
    $("#levelsAccordion" + level.level).accordion(accordionConfig);
    const levelTimerId = "#tslvl" + level.level;
    $(levelTimerId).slider(sliderValue);
    $(levelTimerId).slider("option", "values",
        [convertStringToMilliSeconds(level.start), convertStringToMilliSeconds(level.end)]);

    Object.keys(level.branch).forEach(function (key, idx) {
      $("#branch_" + key + "_" + level.level).accordion(accordionConfig);
      const branchTimerId = "#ts" + level.level + (idx + 1);
      $(branchTimerId).slider(sliderValue);
      $(branchTimerId).slider("option", "values", [
        convertStringToMilliSeconds(level.branch[key].start),
        convertStringToMilliSeconds(level.branch[key].end)
      ]);
    });
  };

  var tmpl = $.templates("#configurationTemplate");
  $.ajax({
    url: "config/config.json",
    dataType: "json",
    success: function(response) {
      config = response;
      levelCounter = config.levels.length;
      tmpl.link("#configurationContainer", config, helpers);
      config.levels.forEach(function(level) {
        initLevel(level);
      });
    }
  });

  $("#configurationAccordion").accordion(accordionConfig);

</script>
</body>
</html>
