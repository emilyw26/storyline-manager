<!doctype html>
<html lang="us">
<head>
    <meta charset="utf-8">
    <title>RIOT Xml Config App</title>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/dark-hive/jquery-ui.css"
          id="theme">
    <link href="css/slider.css" rel="stylesheet">
    <link href="css/accordion.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
</head>
<body>

<script>window.$ = window.jQuery = require('jquery');</script>
<script>var FileSaver = require('file-saver');</script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsviews/0.9.90/jsviews.min.js"></script>


<script src="js/accordion_multi_open.js"></script>
<script src="js/sliderValues.js"></script>
<script src="js/range.js"></script>

<div id="configurationContainer"></div>
<script id="configurationTemplate" type="text/x-jsrender">
    <div id="exportConfiguration">
        <div id="controlgroup">
          <div class="media">
            <label>Video File:</label> <input type="text" class="ui-widget ui-state-default ui-corner-all" data-link="#data.media.video">
            <label>Audio File:</label> <input type="text" class="ui-widget ui-state-default ui-corner-all" data-link="#data.media.audio">
            <br />
            <br />
          </div>
          {^{for levels}}
            {{include tmpl="#levelTemplate" /}}
          {{/for}}
          <div class="buttons">
              <button class="ui-button ui-widget ui-corner-all" data-link="{on ~addLevel}">Add Level</button>
              <button class="ui-button ui-widget ui-corner-all" data-link="{on ~exportConfiguration}">Export Configuration</button>
          </div>
        </div>
    </div>
</script>

<script id="levelTemplate" type="text/x-jsrender">
    <div id="levelsAccordion{{:#getIndex()+1}}">
        <h3>Level {^{:#getIndex()+1}}</h3>
        <div class="content">
            <button class="ui-button ui-widget ui-corner-all" data-link="{on ~removeLevel #getIndex()}">Remove Level</button>
            <div class="timer-range">
                <label for="tslvl{{:level}}">Timeline
                    <span id="tslvl{{:level}}From">{^{:start}}</span> - <span id="tslvl{{:level}}To">{^{:end}}</span>
                </label>
                <div id="tslvl{{:level}}"></div>
            </div>
            {^{props branch}}
                {{include tmpl="#branchTemplate" /}}
            {{/props}}
        </div>
    </div>
</script>

<script id="branchTemplate" type="text/x-jsrender">
  <div id="branch_{{>key}}_{{:#parent.parent.parent.getIndex()+1}}" data-link="class{merge:#data.prop.disabled toggle='disabled-accordion'}">
    <h3>Branch - {{>key}}</h3>
    <div>
        <label><input type="checkbox" data-link="#data.prop.disabled" />Toggle</label>
        <div class="content" data-link="class{merge:#data.prop.disabled toggle='ui-state-disabled'}">
            <div class="timer-range">
                <label for="ts{{:#parent.parent.parent.getIndex()+1}}{{:#getIndex() + 1}}">Timeline
                    <span id="ts{{:#parent.parent.parent.getIndex()+1}}{{:#getIndex() + 1}}From">{^{>prop.start}}</span>
                    - <span id="ts{{:#parent.parent.parent.getIndex()+1}}{{:#getIndex() + 1}}To">{^{>prop.end}}</span>
                </label>
                <div id="ts{{:#parent.parent.parent.getIndex()+1}}{{:#getIndex() + 1}}"></div>
            </div>
            <div class="outcome">
                <label for="o{{:#parent.parent.parent.getIndex()+1}}{{:#getIndex() + 1}}">Outcome</label>
                <select id="o{{:#parent.parent.parent.getIndex()+1}}{{:#getIndex() + 1}}" data-link="prop.outcome">
                    {^{range start=(#parent.parent.parent.getIndex()+1+1) end=~root.levels.length}}
                        <option value={{:#data}}>Level{{:#data}}</option>
                    {{/range}}
                    <option value="0">End</option>
                </select>
            </div>
         </div>
    </div>
  </div>
</script>


<script>

  function convertStringToMilliSeconds(timeString) {
    const parts = timeString.split(':');
    return (Number(parts[0])*60+Number(parts[1].substring(0, parts[1].indexOf('.'))))*1000 + Number(parts[1].indexOf('.')+1);
  }

  var branchEmotions = ["anger", "fear", "calm", "disgust", "contempt", "surprise"];

  const accordionConfig = {
    collapsible: true,
    autoHeight: false,
    heightStyle: 'content',
    expandable: true,
    active: false
  };

  var config;

  var newLevel = {
    "level": 0,
    "start": "00:00.000",
    "end": "00:00.000",
    "branch" : {
      "anger": {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0,
        "disabled": false
      },
      "fear": {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0,
        "disabled": false
      },
      "calm": {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0,
        "disabled": false
      },
      "disgust": {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0,
        "disabled": true
      },
      "contempt": {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0,
        "disabled": true
      },
      "surprise": {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0,
        "disabled": true
      }
    }
  };

  var updateLevels = function () {
    tmpl.link("#configurationContainer", config, helpers);
    config.levels.forEach(function (level, idx) {
      initLevel(level, idx + 1);
    });
  };
  var helpers = {
    addLevel: function() {
      if (config.levels.length === 12) return false;
      const levelValue = Object.assign({}, newLevel);
      levelValue.level = config.levels.length + 1;
      $.observable(config.levels).insert(levelValue);
      initLevel(levelValue, config.levels.length);
    },
    removeLevel: function(index) {
      if (config.levels.length === 0) return false;
      $.observable(config.levels).remove(index);
      updateLevels();
      return false;
    },
    toggleBranch: function(levelIndex, key) {
      const levels = $.observable(config.levels);
      const isDisabled = levels.data()[levelIndex].branch[key].disabled;
      levels.data()[levelIndex].branch[key].disabled = !isDisabled;
    },
    exportConfiguration: function() {
      var blob = new Blob([JSON.stringify(config, null, 2)], {type: "text/plain;charset=utf-8"});
      FileSaver.saveAs(blob, "config.json");
    }
  };

  var initLevel = function (level, levelIndex) {
    $("#levelsAccordion" + levelIndex).accordion(accordionConfig);
    const levelTimerId = "#tslvl" + levelIndex;
    $(levelTimerId).slider(sliderValue);
    $(levelTimerId).slider("values",
        [convertStringToMilliSeconds(level.start), convertStringToMilliSeconds(level.end)]);

    Object.keys(level.branch).forEach(function (key, idx) {
      $("#branch_" + key + "_" + levelIndex).accordion(accordionConfig);
      const branchTimerId = "#ts" + levelIndex + (idx + 1);
      $(branchTimerId).slider(sliderValue);
      $(branchTimerId).slider("values",[
        convertStringToMilliSeconds(level.branch[key].start),
        convertStringToMilliSeconds(level.branch[key].end)]
      );
    });
  };

  var initBranches = function(level) {
    var branch = level.branch;
    var keys = Object.keys(branch);
    var emotionsNotPresentInConfig = branchEmotions.filter(function(n) {
      return keys.indexOf(n) === -1;
    });
    emotionsNotPresentInConfig.forEach(function(emotion) {
      branch[emotion] = {
        "start": "00:00.000",
        "end": "00:00.000",
        "outcome": 0,
        "disabled": true
      };
    })
  };

  var tmpl = $.templates("#configurationTemplate");
  $.ajax({
    url: "config/config.json",
    dataType: "json",
    success: function(response) {
      config = response;
      config.levels.forEach(function(level) {
        initBranches(level);
      });
      tmpl.link("#configurationContainer", config, helpers);
      config.levels.forEach(function(level, idx) {
        initBranches(level);
        initLevel(level, idx+1);
      });
    }
  });

  $("#configurationAccordion").accordion(accordionConfig);

</script>
</body>
</html>
